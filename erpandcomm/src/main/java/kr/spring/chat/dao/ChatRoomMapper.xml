<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper   
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"   
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
<mapper namespace="kr.spring.chat.dao.ChatRoomMapper">
	<resultMap type="chatRoomVO" id="chatRoomMap">
		<result property="memberVO.user_num" column="user_num"/>
	</resultMap>
	
	<!-- 채팅 방 생성 -->
	<insert id="insertRoom" parameterType="chatRoomVO">
		INSERT INTO chat_room (
			room_num,
			room_name,
			room_type,
			description,
			created_by,
			max_members)
		VALUES (
			chat_room_seq.nextval,
			#{room_name},
			#{room_type},
			#{description,jdbcType=VARCHAR},
			#{created_by},
			#{max_members,jdbcType=INTEGER})
	</insert>
	
	<!-- 생성된 방 번호 조회 -->
	<select id="selectLastRoomNum" resultType="long">
		SELECT chat_room_seq.currval FROM dual
	</select>
	
	<!-- 채팅방 목록 조회 -->
	<select id="selectListChatRoom" parameterType="map" resultType="chatRoomVO">
		SELECT DISTINCT
			r.room_num,
			r.room_name,
			r.room_type,
			r.description,
			r.created_by,
			r.max_members,
			r.is_active,
			r.created_at,
			r.updated_at,
			m.role,
			-- 안읽은 메시지 존재 여부 확인 (해당 사용자의 안읽은 메시지가 있으면 true)
			CASE 
				WHEN EXISTS (
					SELECT 1 
					FROM chat_message cm 
					WHERE cm.room_num = r.room_num 
					AND cm.sender_num != #{member_num,jdbcType=BIGINT}
					AND cm.message_num NOT IN (
						SELECT mr.message_num 
						FROM chat_message_read mr 
						WHERE mr.user_num = #{member_num,jdbcType=BIGINT}
					)
				) THEN 1 
				ELSE 0 
			END as hasUnreadMessages
		FROM chat_room r
		JOIN chat_member m ON r.room_num = m.room_num
		WHERE 1=1
		<if test="member_num != null">
			AND m.user_num = #{member_num,jdbcType=BIGINT}
		</if>
		<if test="room_num != null">
			AND r.room_num = #{room_num,jdbcType=BIGINT}
		</if>
		AND r.is_active = 'Y'
		ORDER BY r.created_at DESC
	</select>
</mapper>


































