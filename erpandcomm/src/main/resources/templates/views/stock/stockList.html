<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout_basic}">
<head>
    <meta charset="UTF-8">
    <title>ìƒí’ˆ ëª©ë¡</title>
    <script type="text/javascript" th:src="@{/assets/js/jquery-3.7.1.min.js}"></script>
    <link rel="stylesheet" th:href="@{/assets/css/main.css}">
    <link rel="stylesheet" th:href="@{/assets/css/yn/stock.css}">

</head>
<body>
<div layout:fragment="content" class="page-main">
    <div class="dashboard-wrapper">
		<!-- ì‚¬ì´ë“œë°” -->
		<th:block th:replace="fragments/nav_sidebar :: sidebar"></th:block>
	<main class="main-content">

    <div class="header">
        <h1>ğŸ“¦ ì¬ê³ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>
    </div>

    <div class="dashboard-container">
        <!-- ì•Œë¦¼ ì˜ì—­ -->
        <div id="notificationArea" class="notification-area"></div>

        <!-- ê²€ìƒ‰ ë° í•„í„° -->
        <div class="control-panel">
            <h2>ğŸ” ê²€ìƒ‰ ë° í•„í„°</h2>
            <div class="search-filters">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ìƒí’ˆëª… ë˜ëŠ” ìƒí’ˆë²ˆí˜¸ë¡œ ê²€ìƒ‰...">
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">ì „ì²´</button>
                    <button class="filter-btn" data-filter="low">ì¬ê³ ë¶€ì¡±</button>
                    <button class="filter-btn" data-filter="normal">ì •ìƒ</button>
                    <button class="filter-btn" data-filter="high">ê³¼ë‹¤ì¬ê³ </button>
                </div>
            </div>
        </div>

        <!-- ì¬ê³  í…Œì´ë¸” -->
        <div class="inventory-table">
            <div class="table-header">
                <h2>ğŸ“‹ ì¬ê³  í˜„í™©</h2>
            </div>
            <div class="table-container">
                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th>ìƒí’ˆë²ˆí˜¸</th>
                            <th>ìƒí’ˆëª…</th>
                            <th>í˜„ì¬ì¬ê³ </th>
                            <th>ì¬ê³ ìœ¨</th>
                            <th>ìµœì†Œì¬ê³ </th>
                            <th>ìµœëŒ€ì¬ê³ </th>
                            <th>ìƒíƒœ</th>
                            <th>ìµœì¢…ì…ê³ ì¼</th>
                            <th>ìµœì¢…ì¶œê³ ì¼</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryBody">
                        <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
                <div id="loadingMessage" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
                <div id="noDataMessage" class="no-data" style="display: none;">
                    í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>
    </main>
    </div>
</div>
<div layout:fragment="pageScript">
<script type="text/javascript">
        // ë”ë¯¸ ë°ì´í„° (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ê°€ì ¸ì˜¬ ë°ì´í„°)
        let inventoryData = [
            {
                product_num: 1001,
                product_name: 'ê°¤ëŸ­ì‹œ S24',
                current_quantity: 15,
                min_stock: 10,
                max_stock: 100,
                last_in_date: '2024-01-10',
                last_out_date: '2024-01-12',
                version_num: 1,
                updated_date: '2024-01-12'
            },
            {
                product_num: 1002,
                product_name: 'ì•„ì´í° 15',
                current_quantity: 5,
                min_stock: 10,
                max_stock: 80,
                last_in_date: '2024-01-08',
                last_out_date: '2024-01-11',
                version_num: 1,
                updated_date: '2024-01-11'
            },
            {
                product_num: 1003,
                product_name: 'ê°¤ëŸ­ì‹œ íƒ­ S9',
                current_quantity: 25,
                min_stock: 15,
                max_stock: 50,
                last_in_date: '2024-01-09',
                last_out_date: '2024-01-10',
                version_num: 1,
                updated_date: '2024-01-10'
            },
            {
                product_num: 1004,
                product_name: 'ì—ì–´íŒŸ í”„ë¡œ',
                current_quantity: 55,
                min_stock: 20,
                max_stock: 50,
                last_in_date: '2024-01-07',
                last_out_date: '2024-01-09',
                version_num: 1,
                updated_date: '2024-01-09'
            },
            {
                product_num: 1005,
                product_name: 'ê°¤ëŸ­ì‹œ ì›Œì¹˜ 6',
                current_quantity: 30,
                min_stock: 15,
                max_stock: 60,
                last_in_date: '2024-01-06',
                last_out_date: '2024-01-08',
                version_num: 1,
                updated_date: '2024-01-08'
            }
        ];

        // í•„í„°ëœ ë°ì´í„°
        let filteredData = [...inventoryData];

        // ìƒíƒœ ê³„ì‚° í•¨ìˆ˜
        function getStockStatus(current, min, max) {
            if (current < min) return 'low';
            if (current > max) return 'high';
            return 'normal';
        }

        // ì¬ê³ ìœ¨ ê³„ì‚° í•¨ìˆ˜
        function getStockPercentage(current, min, max) {
            return Math.round((current / max) * 100);
        }

        // ì•Œë¦¼ ê´€ë¦¬ ê°ì²´
        const NotificationManager = {
            notifications: [],
            
            show(type, title, message, duration = 5000) {
                const notification = this.create(type, title, message);
                this.notifications.push(notification);
                
                // ìë™ ì œê±°
                setTimeout(() => {
                    this.remove(notification.id);
                }, duration);
                
                // ì¬ê³  ë¶€ì¡± ì•Œë¦¼ì¸ ê²½ìš° ë¸Œë¼ìš°ì € ì•Œë¦¼ë„ í‘œì‹œ
                if (type === 'error' && title.includes('ì¬ê³  ë¶€ì¡±')) {
                    this.showBrowserNotification(title, message);
                }
            },
            
            create(type, title, message) {
                const id = Date.now() + Math.random();
                const notificationArea = document.getElementById('notificationArea');
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.id = `notification-${id}`;
                
                notification.innerHTML = `
                    <div class="notification-header">
                        <span class="notification-title">${title}</span>
                        <button class="notification-close" onclick="NotificationManager.remove('${id}')">&times;</button>
                    </div>
                    <div class="notification-message">${message}</div>
                    <div class="notification-time">${new Date().toLocaleTimeString()}</div>
                `;
                
                notificationArea.appendChild(notification);
                
                return { id, element: notification };
            },
            
            remove(id) {
                const notification = document.getElementById(`notification-${id}`);
                if (notification) {
                    notification.classList.add('slide-out');
                    setTimeout(() => {
                        notification.remove();
                        this.notifications = this.notifications.filter(n => n.id !== id);
                    }, 300);
                }
            },
            
            showBrowserNotification(title, message) {
                if ('Notification' in window) {
                    if (Notification.permission === 'granted') {
                        new Notification(title, {
                            body: message,
                            icon: 'ğŸ“¦',
                            tag: 'inventory-alert'
                        });
                    } else if (Notification.permission !== 'denied') {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                new Notification(title, {
                                    body: message,
                                    icon: 'ğŸ“¦',
                                    tag: 'inventory-alert'
                                });
                            }
                        });
                    }
                }
            },
            
            clear() {
                this.notifications.forEach(notification => {
                    notification.element.remove();
                });
                this.notifications = [];
            }
        };

        // ì¬ê³  ë¶€ì¡± ì²´í¬ ë° ì•Œë¦¼ í•¨ìˆ˜
        function checkLowStock() {
            const lowStockItems = inventoryData.filter(item => 
                item.current_quantity < item.min_stock
            );
            
            if (lowStockItems.length > 0) {
                lowStockItems.forEach(item => {
                    const shortage = item.min_stock - item.current_quantity;
                    NotificationManager.show(
                        'error',
                        'ğŸš¨ ì¬ê³  ë¶€ì¡± ì•Œë¦¼',
                        `${item.product_name} (${item.product_num})<br>
                         í˜„ì¬: ${item.current_quantity}ê°œ | ìµœì†Œ: ${item.min_stock}ê°œ<br>
                         <strong>${shortage}ê°œ ë¶€ì¡±</strong>`,
                        8000
                    );
                });
            }
        }

        // ì¬ê³  ë³€ë™ ì‹œë®¬ë ˆì´ì…˜ í•¨ìˆ˜ (ì‹¤ì œë¡œëŠ” WebSocketìœ¼ë¡œ ë°›ì„ ë°ì´í„°)
        function simulateStockChange() {
            const randomIndex = Math.floor(Math.random() * inventoryData.length);
            const item = inventoryData[randomIndex];
            const change = Math.floor(Math.random() * 10) - 5; // -5 ~ +4
            
            const oldQuantity = item.current_quantity;
            item.current_quantity = Math.max(0, item.current_quantity + change);
            
            const status = getStockStatus(item.current_quantity, item.min_stock, item.max_stock);
            const oldStatus = getStockStatus(oldQuantity, item.min_stock, item.max_stock);
            
            // ìƒíƒœ ë³€ê²½ ì•Œë¦¼
            if (status !== oldStatus) {
                let message = '';
                let type = 'success';
                
                if (status === 'low') {
                    message = `${item.product_name}ì˜ ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤! (${item.current_quantity}ê°œ)`;
                    type = 'error';
                } else if (status === 'normal' && oldStatus === 'low') {
                    message = `${item.product_name}ì˜ ì¬ê³ ê°€ ì •ìƒ ìˆ˜ì¤€ìœ¼ë¡œ íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤. (${item.current_quantity}ê°œ)`;
                    type = 'success';
                } else if (status === 'high') {
                    message = `${item.product_name}ì˜ ì¬ê³ ê°€ ê³¼ë‹¤í•©ë‹ˆë‹¤. (${item.current_quantity}ê°œ)`;
                    type = 'warning';
                }
                
                if (message) {
                    NotificationManager.show(type, 'ì¬ê³  ìƒíƒœ ë³€ê²½', message);
                }
            }
            
            // í…Œì´ë¸” ì—…ë°ì´íŠ¸
            filterData();
        }

        // í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜
        function renderTable() {
            const tbody = document.getElementById('inventoryBody');
            const noDataMessage = document.getElementById('noDataMessage');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '';
                noDataMessage.style.display = 'block';
                return;
            }

            noDataMessage.style.display = 'none';
            
            tbody.innerHTML = filteredData.map(item => {
                const status = getStockStatus(item.current_quantity, item.min_stock, item.max_stock);
                const percentage = getStockPercentage(item.current_quantity, item.min_stock, item.max_stock);
                const isLowStock = status === 'low';
                
                return `
                    <tr class="${isLowStock ? 'low-stock-row' : ''}" data-product-num="${item.product_num}">
                        <td style="position: relative;">
                            ${item.product_num}
                            ${isLowStock ? '<span class="alert-indicator">!</span>' : ''}
                        </td>
                        <td>${item.product_name}</td>
                        <td><strong>${item.current_quantity}</strong></td>
                        <td>
                            <div class="quantity-bar">
                                <div class="quantity-fill fill-${status}" style="width: ${Math.min(percentage, 100)}%"></div>
                            </div>
                            ${percentage}%
                        </td>
                        <td>${item.min_stock}</td>
                        <td>${item.max_stock}</td>
                        <td>
                            <span class="stock-status status-${status}">
                                ${status === 'low' ? 'ë¶€ì¡±' : status === 'high' ? 'ê³¼ë‹¤' : 'ì •ìƒ'}
                            </span>
                        </td>
                        <td>${item.last_in_date || '-'}</td>
                        <td>${item.last_out_date || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-view" onclick="viewProduct(${item.product_num})">ë³´ê¸°</button>
                                <button class="btn btn-edit" onclick="editProduct(${item.product_num})">ìˆ˜ì •</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ê²€ìƒ‰ í•¨ìˆ˜
        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
            
            filteredData = inventoryData.filter(item => {
                const matchesSearch = item.product_name.toLowerCase().includes(searchTerm) || 
                                    item.product_num.toString().includes(searchTerm);
                
                if (activeFilter === 'all') return matchesSearch;
                
                const status = getStockStatus(item.current_quantity, item.min_stock, item.max_stock);
                return matchesSearch && status === activeFilter;
            });
            
            renderTable();
        }

        // ìƒí’ˆ ë³´ê¸° í•¨ìˆ˜
        function viewProduct(productNum) {
            alert(`ìƒí’ˆ ${productNum} ìƒì„¸ ë³´ê¸°`);
            // ì‹¤ì œë¡œëŠ” ëª¨ë‹¬ì´ë‚˜ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
        }

        // ìƒí’ˆ ìˆ˜ì • í•¨ìˆ˜
        function editProduct(productNum) {
            alert(`ìƒí’ˆ ${productNum} ìˆ˜ì •`);
            // ì‹¤ì œë¡œëŠ” ìˆ˜ì • í¼ìœ¼ë¡œ ì´ë™
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.addEventListener('DOMContentLoaded', function() {
            // ê²€ìƒ‰ ì…ë ¥ ì´ë²¤íŠ¸
            document.getElementById('searchInput').addEventListener('input', filterData);
            
            // í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterData();
                });
            });
            
            renderTable();
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¬ê³  ë¶€ì¡± ì²´í¬
            checkLowStock();
            
            // ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // ì‹¤ì‹œê°„ ì¬ê³  ë³€ë™ ì‹œë®¬ë ˆì´ì…˜ (10ì´ˆë§ˆë‹¤)
            setInterval(simulateStockChange, 10000);
        });

        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜ (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´)
        function refreshData() {
            const loadingMessage = document.getElementById('loadingMessage');
            loadingMessage.style.display = 'block';
            
            // ì‹¤ì œë¡œëŠ” fetch APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            setTimeout(() => {
                loadingMessage.style.display = 'none';
                renderTable();
                updateStats();
            }, 1000);
        }
    </script>
    </div>
</body>
</html>