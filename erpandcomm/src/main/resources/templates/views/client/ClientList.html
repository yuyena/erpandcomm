<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layouts/layout_basic}">
<head>
    <meta charset="UTF-8">
    <title>거래처 목록</title>
    <link rel="stylesheet" th:href="@{/assets/css/main.css}">
    <link rel="stylesheet" th:href="@{/assets/css/sh.css}">
</head>
<body>
<div layout:fragment="content" class="page-main">
    <div class="dashboard-wrapper">
        <th:block th:replace="fragments/nav_sidebar :: sidebar"></th:block>
        <main class="main-content">
            <div class="main-header">
                <h2>ERP 관리 - 거래처 관리</h2>
            </div>
            
            <div class="card" style="width: 800px; padding: 0; margin: 0 auto 24px auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.08);">
              <div style="width:800px; min-height:200px; margin:0 auto; text-align:center;">
                <canvas id="clientPieChart" style="display: inline-block; width: 400px; height: 400px; box-sizing: border-box;" width="400" height="400"></canvas>
              </div>
            </div>
            
            <div class="list-header">
              <span class="list-title">거래처 목록</span>
              <a th:href="@{/client/form}" class="btn-write">거래처 등록</a>
            </div>
            <div class="sh-box">
              <!-- 고객 목록, 공급업체 목록 테이블 flex row -->
                <!-- 고객 목록 -->
                <div class="table-container" style="flex: 1; min-width:0; width:100%;">
                    <h3 style="margin-bottom: 15px; color: #333; font-size: 1.1rem;">고객 목록</h3>
                    <form id="clientListForm" method="post" th:action="@{/client/deleteSelected}">
                      <table class="custom-table" style="width:85%">
                        <thead>
                          <tr>
                            <th style="width:5%"><input type="checkbox" id="allChk" onclick="toggleAll(this)"></th>
                            <th style="width:9%">이름</th>
                            <th style="width:9%">담당자</th>
                            <th style="width:10%">연락처</th>
                            <th style="width:13%">상세보기</th>
                            <th style="width:18%">수정/삭제</th>
                          </tr>
                        </thead>
                        <tbody>
                          <th:block th:each="client, stat : ${list}">
                            <tr th:if="${client.client_type == 1}">
                              <td><input type="checkbox" name="clientChk" th:value="${client.client_num}"></td>
                              <td th:text="${client.client_name}"></td>
                              <td th:text="${client.contact_person}"></td>
                              <td th:text="${client.phone}"></td>
                              <td>
                                <button type="button" class="btn-detail" th:attr="data-idx=${stat.index}" onclick="toggleDetail(this)">상세보기</button>
                              </td>
                              <td style="padding:2px 4px;">
                                <a th:href="@{/client/form(client_num=${client.client_num})}" class="btn-detail" style="background:#2ecc71; margin-right:2px;">수정</a>
                                <a th:href="@{/client/delete(client_num=${client.client_num})}" class="btn-detail" style="background:#e74c3c; margin-left:2px;" onclick="return confirm('정말 삭제하시겠습니까?');">삭제</a>
                              </td>
                            </tr>
                            <tr th:if="${client.client_type == 1}" th:id="'detail-row-' + ${stat.index}" class="detail-row" style="display:none;">
                              <td colspan="6">
                                <b>주소:</b> <span th:text="${client.address1} + ' ' + ${client.address2}"></span>
                                &nbsp;|&nbsp;
                                <b>연락처:</b> <span th:text="${client.phone}"></span>
                              </td>
                            </tr>
                          </th:block>
                        </tbody>
                      </table>
                      <div style="margin-top:10px; text-align:right;">
                        <button type="button" onclick="deleteSelected()" style="background:#e74c3c; color:#fff; border:none; border-radius:5px; padding:6px 16px; font-weight:600; cursor:pointer;">선택 삭제</button>
                      </div>
                    </form>
                    <script>
                    function toggleAll(all) {
                      const chks = document.querySelectorAll('input[name=\"clientChk\"]');
                      chks.forEach(function(chk) { chk.checked = all.checked; });
                    }
                    function deleteSelected() {
                      const form = document.getElementById('clientListForm');
                      const checked = document.querySelectorAll('input[name=\"clientChk\"]:checked');
                      if (checked.length === 0) {
                        alert('삭제할 거래처를 선택하세요.');
                        return;
                      }
                      if (confirm('정말 선택한 거래처를 삭제하시겠습니까?')) {
                        form.submit();
                      }
                    }
                    </script>
                </div>
                
                <!-- 공급업체 목록 -->
                <div class="table-container" style="flex: 1; min-width:0; width:100%;">
                    <h3 style="margin-bottom: 15px; color: #333; font-size: 1.1rem;">공급업체 목록</h3>
                    <form id="supplierListForm" method="post" th:action="@{/client/deleteSelected}">
                        <table class="custom-table" style="width:85%">
                            <thead>
                                <tr>
                                    <th style="width:5%"><input type="checkbox" id="allSupplierChk" onclick="toggleAllSupplier(this)"></th>
                                    <th style="width:9%">이름</th>
                                    <th style="width:9%">담당자</th>
                                    <th style="width:10%">연락처</th>
                                    <th style="width:13%">상세보기</th>
                                    <th style="width:18%">수정/삭제</th>
                                </tr>
                            </thead>
                            <tbody>
                                <th:block th:each="client, stat : ${list}">
                                    <tr th:if="${client.client_type == 0}">
                                        <td><input type="checkbox" name="supplierChk" th:value="${client.client_num}"></td>
                                        <td th:text="${client.client_name}"></td>
                                        <td th:text="${client.contact_person}"></td>
                                        <td th:text="${client.phone}"></td>
                                        <td>
                                            <button type="button" class="btn-detail" th:attr="data-idx=${stat.index}" onclick="toggleSupplierDetail(this)">상세보기</button>
                                        </td>
                                        <td style="padding:2px 4px;">
                                            <a th:href="@{/client/form(client_num=${client.client_num})}" class="btn-detail" style="background:#2ecc71; margin-right:2px;">수정</a>
                                            <a th:href="@{/client/delete(client_num=${client.client_num})}" class="btn-detail" style="background:#e74c3c; margin-left:2px;" onclick="return confirm('정말 삭제하시겠습니까?');">삭제</a>
                                        </td>
                                    </tr>
                                    <tr th:if="${client.client_type == 0}" th:id="'supplier-detail-row-' + ${stat.index}" class="detail-row" style="display:none;">
                                        <td colspan="6">
                                            <b>주소:</b> <span th:text="${client.address1} + ' ' + ${client.address2}"></span>
                                            &nbsp;|&nbsp;
                                            <b>연락처:</b> <span th:text="${client.phone}"></span>
                                            &nbsp;|&nbsp;
                                            <b>이메일:</b> <span th:text="${client.email}"></span>
                                        </td>
                                    </tr>
                                </th:block>
                            </tbody>
                        </table>
                        <div style="margin-top:10px; text-align:right;">
                            <button type="button" onclick="deleteSelectedSupplier()" style="background:#e74c3c; color:#fff; border:none; border-radius:5px; padding:6px 16px; font-weight:600; cursor:pointer;">선택 삭제</button>
                        </div>
                    </form>
                </div>
            </div>
            <script>
            function toggleAll(all) {
              const chks = document.querySelectorAll('input[name=\"clientChk\"]');
              chks.forEach(function(chk) { chk.checked = all.checked; });
            }
            function deleteSelected() {
              const form = document.getElementById('clientListForm');
              const checked = document.querySelectorAll('input[name=\"clientChk\"]:checked');
              if (checked.length === 0) {
                alert('삭제할 거래처를 선택하세요.');
                return;
              }
              if (confirm('정말 선택한 거래처를 삭제하시겠습니까?')) {
                form.submit();
              }
            }
            function toggleSupplierDetail(btn) {
                var idx = btn.getAttribute('data-idx');
                var detailRow = document.getElementById('supplier-detail-row-' + idx);
                // 이미 열려있으면 닫기
                if (detailRow.style.display === '' || detailRow.style.display === 'table-row') {
                    detailRow.style.display = 'none';
                    btn.textContent = '상세보기';
                    return;
                }
                // 모든 상세행 닫기
                document.querySelectorAll('.detail-row').forEach(function(row) {
                    row.style.display = 'none';
                });
                // 모든 버튼 텍스트 초기화
                document.querySelectorAll('.btn-detail').forEach(function(b) {
                    if(b.tagName === 'BUTTON') b.textContent = '상세보기';
                });
                // 펼치기
                detailRow.style.display = '';
                btn.textContent = '닫기';
            }
            </script>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
            document.addEventListener('DOMContentLoaded', function() {
              const ctx = document.getElementById('clientPieChart').getContext('2d');
              const clientPieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                  labels: ['A상사', 'B상사', 'C상사'],
                  datasets: [{
                    label: '거래처별 구매금액',
                    data: [300000, 200000, 100000],
                    backgroundColor: [
                      'rgba(255, 99, 132, 0.5)',
                      'rgba(54, 162, 235, 0.5)',
                      'rgba(255, 206, 86, 0.5)'
                    ]
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: true,
                  plugins: {
                    legend: { display: true }
                  }
                }
              });
            });
            </script>
        </main>
    </div>
</div>
</body>
</html>
<style>
.list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}
.list-title {
    font-size: 1.2rem;
    font-weight: bold;
}
.btn-write {
    background: #528eff;
    color: #fff !important;
    padding: 8px 20px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
}
.custom-table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    font-size: 9pt;
}
.custom-table th, .custom-table td {
    border-bottom: 1px solid #eee;
    padding: 2px 8px;
    text-align: center;
    font-size: 9pt;
}
.custom-table th {
    background: #fafafa;
    font-weight: 600;
    height: 38px;
    padding: 8px 8px;
    font-size: 1.1em;
}
.btn-detail {
    background: #528eff;
    color: #fff !important;
    border: none;
    border-radius: 6px;
    padding: 4px 11px;
    text-decoration: none;
    font-size: 0.67rem;
    font-weight: 500;
    margin: 0 1px;
}
/* 상세정보 행만 별도 스타일 */
.detail-row td {
    border-bottom: 1px solid #eee;
    background: #fff;
    padding: 8px 6px 8px 12px;
    font-size: 9pt;
    text-align: left;
    color: #222;
    border-top: none;
}
.detail-row {
    /* 위쪽에 약간의 여백 */
    height: 1.5em;
}
.table-container {
  flex: 1 1 auto;
  min-width: 0;
  width: 100%;
  max-width: 100%;
}
.sh-box {
  display: flex;
  gap: 10px;
  width: 100%;
}
.page-main, .dashboard-wrapper, .main-content, .card {
  padding: 0 !important;
  margin: 0 !important;
  width: 100vw !important;
  max-width: 100vw !important;
  box-sizing: border-box;
}
</style> 