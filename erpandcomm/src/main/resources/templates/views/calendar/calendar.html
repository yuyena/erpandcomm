<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layouts/layout_basic}">
<head>
  <meta charset="UTF-8">
  <title>캘린더</title>
  <meta name="csrf-token" th:content="${_csrf.token}">
  <meta name="csrf-header" th:content="${_csrf.headerName}">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/calendar.css">
</head>
<body>
<div layout:fragment="content" class="page-main">
  <div class="dashboard-wrapper">
    <th:block th:replace="fragments/nav_sidebar :: sidebar"></th:block>
    <main class="main-content">
      <div class="page-header" style="margin-bottom:32px;">
        <h2 class="page-title" style="font-size:1.6rem; font-weight:bold; color:#285CC3;">캘린더</h2>
        <button id="calendar-add-btn" style="background:#2176e8; color:#fff; border:none; border-radius:6px; font-size:1rem; font-weight:500; padding:8px 22px; margin-left:auto; cursor:pointer;">일정 등록</button>
      </div>
      <div style="width:1100px; margin:0 auto;">
        <div class="card" style="background:#fff; border-radius:14px; box-shadow:0 2px 12px rgba(80,120,200,0.07); padding:40px;">
          <div id="calendar"></div>
        </div>
      </div>
    </main>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
  // CSRF 토큰 fetch 요청에 자동 추가
  function csrfFetch(url, options = {}) {
    const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const header = document.querySelector('meta[name="csrf-header"]').getAttribute('content');
    options.headers = options.headers || {};
    if (token && header) options.headers[header] = token;
    return fetch(url, options);
  }
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'ko',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: ''
      },
      dayCellContent: function(arg) {
        return arg.date.getDate();
      },
      events: function(fetchInfo, successCallback, failureCallback) {
        const start = fetchInfo.startStr.slice(0, 10);
        const end = fetchInfo.endStr.slice(0, 10);
        csrfFetch(`/calendar/month?monthStart=${start}&monthEnd=${end}`)
          .then(res => res.json())
          .then(data => {
            successCallback(Array.isArray(data) ? data.map(item => ({
              id: item.calendar_id,
              title: item.title,
              start: item.created_at,
              allDay: true,
              backgroundColor: item.is_public === 'Y' ? '#2176e8' : '#aaa',
              borderColor: '#2176e8',
              extendedProps: item
            })) : []);
          });
      },
      dateClick: function(info) {
        showAddModal(info.dateStr);
      },
      eventClick: function(info) {
        showEditModal(info.event);
      }
    });
    calendar.render();

    // 일정 등록 모달
    function showAddModal(dateStr) {
      const title = prompt('일정 제목을 입력하세요:');
      if (title) {
        csrfFetch('/calendar/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, is_public: 'Y', created_at: dateStr })
        }).then(() => calendar.refetchEvents());
      }
    }
    // 일정 수정/삭제 모달
    function showEditModal(event) {
      const action = confirm(`[수정/삭제]\n수정: 확인, 삭제: 취소`);
      if (action) {
        const newTitle = prompt('새 일정 제목:', event.title);
        if (newTitle && newTitle !== event.title) {
          csrfFetch('/calendar/update', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ calendar_id: event.id, title: newTitle })
          }).then(() => calendar.refetchEvents());
        }
      } else {
        if (confirm('정말 삭제하시겠습니까?')) {
          csrfFetch(`/calendar/delete/${event.id}`, { method: 'DELETE' })
            .then(() => calendar.refetchEvents());
        }
      }
    }
    // 상단 버튼으로도 일정 등록
    document.getElementById('calendar-add-btn').onclick = function() {
      showAddModal(new Date().toISOString().slice(0,10));
    };
  });
</script>
</body>
</html> 