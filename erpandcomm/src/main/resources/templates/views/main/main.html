<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{layouts/layout_basic}">
<head>
<meta charset="UTF-8">
<title>Office ERP - 대시보드</title>
<style>
    .page-main .page-header {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      margin-bottom: 60px !important;
      padding: 40px 40px 30px 40px !important;
      border-bottom: 2px solid #e0e0e0 !important;
    }
    .page-main .page-title {
      font-size: 1.5rem !important;
      font-weight: bold !important;
      color: #3b6fd6 !important;
      margin: 0 !important;
    }
    </style>
</head>
<body>
<div layout:fragment="content" class="page-main">
	<div class="dashboard-wrapper">
		<!-- 사이드바 -->
		<th:block th:replace="fragments/nav_sidebar :: sidebar"></th:block>

		<!-- 메인 컨텐츠 -->
		<main class="main-content">
			<div class="page-header">
				<h2 class="page-title-dashboard">대시보드</h2>
			</div>
			<div class="welcome-message" style="font-size: 2.3rem; font-weight: bold; color: #2851a3; margin-bottom: 50px; margin-left:30px;">
				<span th:if="${loginMember != null}" th:text="${loginMember.user_name} + ' 님, 환영합니다!'">로그인 사용자 닉네임</span>
				<span th:if="${loginMember == null}">로그인 해주세요.</span>
			</div>
			<div style="width:100%; box-sizing:border-box;">
				<h3 style="font-size:1.5rem; font-weight:bold; margin-bottom:13px; color:#2851a3; padding-left:23px;">공지사항</h3>
				<div style="background:#fff; border-radius:14px; box-shadow:0 2px 12px rgba(80,120,200,0.07); padding: 5px 30px 12px 10px; width:1200px; margin-left:20px; margin-right:0; box-sizing:border-box;">
					<table style="width:100%; border-collapse:collapse; background:none;">
						<tbody>
							<tr th:each="notice, stat : ${noticeList}" th:if="${stat.index} < 3" style="border-bottom:1px solid #e0e6f0; transition:background 0.15s;" onmouseover="this.style.background='#f5f8ff'" onmouseout="this.style.background='none'">
								<td style="padding:14px 24px 14px 8px; color:#2176e8; font-weight:bold; text-align:center; width:12%;">중요공지</td>
								<td style="padding:14px 32px 14px 10px; color:#373737; font-weight:600; text-align:left; width:73%;" th:text="${notice.noti_title}"></td>
								<td style="padding:14px 10px; color:#888; text-align:center; width:15%;" th:text="${#dates.format(notice.noti_date, 'yyyy-MM-dd')}"></td>
							</tr>
							<tr th:if="${noticeList == null or noticeList.size() == 0}">
								<td colspan="3" style="color:#888; font-size:15px; padding:14px 10px; text-align:center;">공지사항이 없습니다.</td>
							</tr>
						</tbody>
					</table>
					<div style="text-align:right; margin-top:6px;">
						<a href="/notice/noticeList" style="font-size:13px; color:#2176e8;">더보기</a>
					</div>
				</div>
			</div>
			<div style="width:1200px; margin-left:120px; margin-right:0;">
			</div>
			<div style="display: flex; flex-direction: row; justify-content: flex-start; gap: 48px; width:1200px; margin-left:20px; margin-right:0;">
				<div style="display: flex; flex-direction: column; align-items: flex-start; width: 600px;">
					<div style="font-size:1.3rem; font-weight:bold; color:#2851a3; margin-bottom: 6px; margin-left: 6px; margin-top:30px;">판매주문 통계</div>
					<div style="background: #fff; border-radius: 16px; box-shadow: 0 2px 12px rgba(80,120,200,0.07); width: 100%; height: 380px; display: flex; align-items: center; justify-content: center;">
						<canvas id="salesOrderChart" width="520" height="320"></canvas>
					</div>
				</div>
				<div style="display: flex; flex-direction: column; align-items: flex-start; width: 600px;">
					<div style="font-size:1.3rem; font-weight:bold; color:#2851a3; margin-bottom: 6px; margin-left: 6px; margin-top:30px;">구매주문 통계</div>
					<div style="background: #fff; border-radius: 16px; box-shadow: 0 2px 12px rgba(80,120,200,0.07); width: 100%; height: 380px; display: flex; align-items: center; justify-content: center;">
						<canvas id="purchaseOrderChart" width="520" height="320"></canvas>
					</div>
				</div>
			</div>
		</main>
	</div>
</div>
<div layout:fragment="pageScript">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // 판매주문 그래프
  fetch('/sales/stats/monthly')
    .then(res => res.json())
    .then(data => {
      const labels = data.map(item => (item.MONTH || item.month));
      const totals = data.map(item => item.TOTAL || item.total);
      new Chart(document.getElementById('salesOrderChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '판매주문',
            data: totals,
            backgroundColor: 'rgba(79,140,255,0.5)'
          }]
        },
        options: {
          plugins: { legend: { display: true, position: 'top', align: 'end' } },
          scales: {
            x: {
              ticks: { display: false },
              grid: { display: false }
            },
            y: {
              beginAtZero: true,
              ticks: { display: false },
              grid: { display: true }
            }
          }
        }
      });
    });
  // 구매주문 그래프
  fetch('/purchase/stats/monthly')
    .then(res => res.json())
    .then(data => {
      const labels = data.map(item => (item.MONTH || item.month));
      const totals = data.map(item => item.TOTAL || item.total);
      new Chart(document.getElementById('purchaseOrderChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '구매주문',
            data: totals,
            backgroundColor: 'rgba(255,206,86,0.5)'
          }]
        },
        options: {
          plugins: { legend: { display: true, position: 'top', align: 'end' } },
          scales: {
            x: {
              ticks: { display: false },
              grid: { display: false }
            },
            y: {
              beginAtZero: true,
              ticks: { display: false },
              grid: { display: true }
            }
          }
        }
      });
    });
});

function toggleNotice(btn) {
  const tr = btn.closest('tr');
  const next = tr.nextElementSibling;
  if (next && next.classList.contains('notice-content-row')) {
    next.style.display = (next.style.display === 'table-row') ? 'none' : 'table-row';
    btn.textContent = (next.style.display === 'table-row') ? '-' : '+';
  }
}
</script>
</div>
</body>
</html>