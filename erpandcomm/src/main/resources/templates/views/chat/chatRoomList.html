<!-- chatRoomList.html: ì±„íŒ…ë°© ëª©ë¡ + ì±„íŒ…ì°½ 2ë¶„í•  êµ¬ì¡° -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout_basic}">
<head>
    <meta charset="UTF-8">
    <title>ì±„íŒ…ë°© ëª©ë¡</title>
    <link rel="stylesheet" th:href="@{/assets/css/main.css}">
    <link rel="stylesheet" th:href="@{/assets/css/jm/chatRoomList.css}">
    <link rel="stylesheet" th:href="@{/assets/css/jm/chatView.css}">
    <script type="text/javascript" th:src="@{/assets/js/jquery-3.7.1.min.js}"></script>
    <script type="text/javascript" th:src="@{/assets/js/chat.delete.js}"></script>
</head>
<body>
<div layout:fragment="content" class="page-main">
    <div class="dashboard-wrapper">
        <th:block th:replace="fragments/nav_sidebar :: sidebar" />
        <!-- 2ë¶„í• : ì™¼ìª½ ì±„íŒ…ë°© ëª©ë¡ / ì˜¤ë¥¸ìª½ ì±„íŒ…ì°½ -->
        <div class="chat-split-container">
            <!-- ì™¼ìª½: ì±„íŒ…ë°© ëª©ë¡ -->
            <div class="chat-room-list-container">
                <div class="chat-room-list-header">
                    <h2>ì±„íŒ…ë°© ëª©ë¡</h2>
                    <a th:href="@{'/chat/createRoom'}" class="create-btn">+ ì±„íŒ…ë°© ë§Œë“¤ê¸°</a>
                </div>
                <table class="chat-room-table">
                    <thead>
                        <tr>
                            <th>ë°© ë²ˆí˜¸</th>
                            <th>ë°© ì´ë¦„</th>
                            <th>íƒ€ì…</th>
                            <th>ì„¤ëª…</th>
                            <th>ìµœëŒ€ ì¸ì›</th>
                            <th>ìƒì„±ì¼</th>
                            <th>ì…ì¥</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="room : ${chatRoomList}">
                            <td th:text="${room.room_num}"></td>
                            <td th:text="${room.room_name}"></td>
                            <td th:text="${room.room_type}"></td>
                            <td class="description-cell" th:text="${room.description != null ? (room.description.length() > 20 ? room.description.substring(0, 20) + '...' : room.description) : ''}" th:title="${room.description}"></td>
                            <td th:text="${room.max_members}"></td>
                            <td th:text="${#dates.format(room.created_at, 'yyyy-MM-dd')}"></td>
							<td>
								<button class="enter-btn" th:data-room-id="${room.room_num}">ì…ì¥</button>
								<th:block th:if="${room.role == 'ë°©ì¥'}">
									<button class="delete-btn" th:data-room-id="${room.room_num}">ì‚­ì œ</button>
								</th:block>
							</td>
							</tr>
                        <tr th:if="${#lists.isEmpty(chatRoomList)}">
                            <td colspan="8" class="no-chat-room">ì°¸ì—¬ì¤‘ì¸ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- ì˜¤ë¥¸ìª½: ì±„íŒ…ì°½ (ë™ì  ì‚½ì…) -->
            <div class="chat-room-view-container" id="chatRoomViewContainer">
                <!-- ì…ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ AJAXë¡œ chatView.html ë‚´ìš©ì´ ì´ê³³ì— ì‚½ì…ë¨ -->
                <div class="chat-room-placeholder">
                    <p>í™˜ì˜í•©ë‹ˆë‹¤!</p>
                    <p>ì™¼ìª½ ëª©ë¡ì—ì„œ ì±„íŒ…ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                </div>
            </div>
        </div>
    </div>
</div>
<div layout:fragment="pageScript">
<script th:inline="javascript">
// Thymeleaf ë³€ìˆ˜ ì„ ì–¸
const contextPath = /*[[@{/}]]*/ '';

// ì…ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ AJAXë¡œ ì±„íŒ…ë°© ì…ì¥
$(document).on('click', '.enter-btn', function() {
    var roomId = $(this).attr('data-room-id');  // data() ëŒ€ì‹  attr() ì‚¬ìš©
    var $btn = $(this);
    
    // ë²„íŠ¼ ë¹„í™œì„±í™”
    $btn.prop('disabled', true).text('ì…ì¥ì¤‘...');
    
    // ë¨¼ì € ì±„íŒ…ë°© ì…ì¥ ì²˜ë¦¬
    $.ajax({
        url: contextPath + 'chat/enter/' + roomId,
        type: 'GET',
        success: function(response) {
            if (response.result === 'success') {
                // ì±„íŒ…ë°© ë·° ì»¨í…Œì´ë„ˆì— ì±„íŒ… UI êµ¬ì„±
                var chatHtml = `
                    <div class="chat-view-wrapper">
                        <div class="chat-header">
                            <div class="chat-header-title">
                                <span>${response.room.room_name}</span>
                            </div>
                            <div class="chat-header-actions">
                                <button class="chat-header-btn" title="ë©¤ë²„ ëª©ë¡" onclick="toggleMemberList()"><span>ğŸ‘¥</span></button>
                                <button class="chat-header-btn" title="íŒŒì¼ì²¨ë¶€"><span>ğŸ“</span></button>
                                <button class="chat-header-btn" title="ì„¤ì •"><span>âš™ï¸</span></button>
                            </div>
                        </div>
                        
                        <div class="chat-member-list" id="memberList" style="display: none;">
                            <div class="member-list-header">
                                <h4>ë©¤ë²„ ëª©ë¡</h4>
                                <button onclick="toggleMemberList()" class="close-btn">Ã—</button>
                            </div>
                            <div class="member-list-content">
                                ${response.memberList.map(member => `
                                    <div class="member-item">
                                        <span class="member-name">${member.user_name}</span>
                                        <span class="member-role">${member.role}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="chat-messages" id="chatMessages">
                            ${response.messageList && response.messageList.length > 0 ? 
                                response.messageList.map(message => `
                                    <div class="chat-message-row ${message.sender_num == response.currentUserNum ? 'me' : ''}">
                                        <div class="chat-bubble">${message.content}</div>
                                        <div class="chat-message-meta">${message.sent_at}</div>
                                    </div>
                                `).join('') : 
                                `<div class="no-message">
                                    <p>ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                                    <p>ì²« ë²ˆì§¸ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”!</p>
                                </div>`
                            }
                        </div>
                        
                        <form class="chat-input-area" id="chatSendForm" autocomplete="off">
                            <input type="hidden" name="room_num" value="${response.room.room_num}">
                            <input type="text" class="chat-input" name="message" id="chatMessageInput" 
                                   placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" required>
                            <button type="submit" class="chat-send-btn">ë³´ë‚´ê¸°</button>
                        </form>
                    </div>
                `;
                
                $('#chatRoomViewContainer').html(chatHtml);
                
                // ëª¨ë“  ì…ì¥ ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
                $('.enter-btn').removeClass('active');
                // í´ë¦­ëœ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
                $btn.addClass('active');
                
                // WebSocket ì—°ê²° ì´ˆê¸°í™”
                if (typeof connectWebSocket === 'function') {
                    connectWebSocket();
                }
                
                // ìŠ¤í¬ë¡¤ì„ ìµœí•˜ë‹¨ìœ¼ë¡œ ì´ë™
                var chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            } else {
                alert(response.message || 'ì±„íŒ…ë°© ì…ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        },
        error: function(xhr) {
            var errorMsg = 'ì±„íŒ…ë°©ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
            }
            alert(errorMsg);
            $('#chatRoomViewContainer').html(`
                <div class="chat-room-error">
                    <p>${errorMsg}</p>
                    <p>ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                </div>
            `);
        },
        complete: function() {
            // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
            $btn.prop('disabled', false).text('ì…ì¥');
        }
    });
});

// ë©¤ë²„ ëª©ë¡ í† ê¸€ í•¨ìˆ˜
function toggleMemberList() {
    var memberList = document.getElementById('memberList');
    if (memberList.style.display === 'none') {
        memberList.style.display = 'block';
    } else {
        memberList.style.display = 'none';
    }
}
</script>
</div>
</body>
</html>