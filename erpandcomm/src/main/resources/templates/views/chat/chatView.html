<!-- chatView.html: ì±„íŒ…ë°© ìƒì„¸ ë·° -->
<div class="chat-view-wrapper">
    <!-- ìƒë‹¨ í—¤ë” -->
    <div class="chat-header">
        <div class="chat-header-title">
            <span th:if="${room != null}" th:text="${room.room_name}">ì±„íŒ…ë°©</span>
            <span th:if="${error != null}" th:text="${error}" style="color: #e53935;"></span>
        </div>
        <div class="chat-header-actions" th:if="${room != null}">
            <button class="chat-header-btn" title="ë©¤ë²„ ëª©ë¡" onclick="toggleMemberList()"><span>ğŸ‘¥</span></button>
            <button class="chat-header-btn" title="íŒŒì¼ì²¨ë¶€"><span>ğŸ“</span></button>
            <button class="chat-header-btn" title="ì„¤ì •"><span>âš™ï¸</span></button>
        </div>
    </div>
    
    <!-- ë©¤ë²„ ëª©ë¡ (ìˆ¨ê¹€) -->
    <div class="chat-member-list" id="memberList" style="display: none;">
        <div class="member-list-header">
            <h4>ë©¤ë²„ ëª©ë¡</h4>
            <button onclick="toggleMemberList()" class="close-btn">Ã—</button>
        </div>
        <div class="member-list-content">
            <div th:each="member : ${memberList}" class="member-item">
                <span class="member-name" th:text="${member.user_name}">ì‚¬ìš©ì</span>
                <span class="member-role" th:text="${member.role}">ë©¤ë²„</span>
            </div>
        </div>
    </div>
    
    <!-- ë©”ì‹œì§€ ëª©ë¡ -->
    <div class="chat-messages" id="chatMessages" th:if="${room != null}">
        <!-- ë©”ì‹œì§€ê°€ ì—†ì„ ë•Œ -->
        <div class="no-message" th:if="${messageList == null || #lists.isEmpty(messageList)}">
            <p>ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <p>ì²« ë²ˆì§¸ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”!</p>
        </div>
        
        <!-- ë©”ì‹œì§€ ëª©ë¡ (ë‚˜ì¤‘ì— êµ¬í˜„) -->
        <div th:each="message : ${messageList}" class="chat-message-row" 
             th:classappend="${message.sender_num == currentUserNum ? 'me' : ''}">
            <div class="chat-bubble" th:text="${message.content}">ë©”ì‹œì§€</div>
            <div class="chat-message-meta" th:text="${message.sent_at}">ì‹œê°„</div>
        </div>
    </div>
    
    <!-- ì…ë ¥ì°½ -->
    <form class="chat-input-area" id="chatSendForm" autocomplete="off" th:if="${room != null}">
        <input type="hidden" name="room_num" th:value="${room.room_num}">
        <input type="text" class="chat-input" name="message" id="chatMessageInput" 
               placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" required>
        <button type="submit" class="chat-send-btn">ë³´ë‚´ê¸°</button>
    </form>
</div>

<script th:inline="javascript">
// WebSocket ì—°ê²°
var socket = null;
var roomNum = /*[[${room != null ? room.room_num : 'null'}]]*/ 'null';
var currentUserNum = /*[[${currentUserNum}]]*/ 0;

// WebSocket ì—°ê²° í•¨ìˆ˜
function connectWebSocket() {
    if (roomNum && roomNum !== 'null') {
        socket = new WebSocket('ws://' + window.location.host + '/message-ws');
        
        socket.onopen = function(event) {
            console.log('WebSocket ì—°ê²°ë¨');
            // ë°© ì…ì¥ ë©”ì‹œì§€ ì „ì†¡
            var joinMessage = {
                type: 'join',
                roomNum: roomNum,
                userNum: currentUserNum
            };
            socket.send(JSON.stringify(joinMessage));
        };
        
        socket.onmessage = function(event) {
            console.log('ë©”ì‹œì§€ ìˆ˜ì‹ :', event.data);
            var data = JSON.parse(event.data);
            
            if (data.type === 'message') {
                // ìƒˆ ë©”ì‹œì§€ ì¶”ê°€
                addMessageToChat(data);
            }
        };
        
        socket.onclose = function(event) {
            console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
        };
        
        socket.onerror = function(error) {
            console.error('WebSocket ì˜¤ë¥˜:', error);
        };
    }
}

// ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì°½ì— ì¶”ê°€
function addMessageToChat(data) {
    var isMyMessage = data.senderNum == currentUserNum;
    var messageHtml = '<div class="chat-message-row' + (isMyMessage ? ' me' : '') + '">' +
                     '<div class="chat-bubble">' + data.content + '</div>' +
                     '<div class="chat-message-meta">ë°©ê¸ˆ</div>' +
                     '</div>';
    
    $('#chatMessages').append(messageHtml);
    $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
}

// ë©¤ë²„ ëª©ë¡ í† ê¸€
function toggleMemberList() {
    var memberList = document.getElementById('memberList');
    if (memberList.style.display === 'none') {
        memberList.style.display = 'block';
    } else {
        memberList.style.display = 'none';
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ WebSocket ì—°ê²°
$(document).ready(function() {
    if (roomNum && roomNum !== 'null') {
        connectWebSocket();
    }
    
    // ë©”ì‹œì§€ ì „ì†¡
    $('#chatSendForm').on('submit', function(e) {
        e.preventDefault();
        var message = $('#chatMessageInput').val().trim();
        if (!message) return;
        
        if (socket && socket.readyState === WebSocket.OPEN) {
            // WebSocketìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
            var messageData = {
                type: 'message',
                roomNum: roomNum,
                senderNum: currentUserNum,
                content: message
            };
            socket.send(JSON.stringify(messageData));
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            $('#chatMessageInput').val('');
        } else {
            alert('ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        }
    });
    
    // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
    $('#chatMessageInput').on('keypress', function(e) {
        if (e.which === 13 && !e.shiftKey) {
            e.preventDefault();
            $('#chatSendForm').submit();
        }
    });
});
</script>