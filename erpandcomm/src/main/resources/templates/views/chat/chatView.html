<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout_basic}">
<head>
    <title>ì±„íŒ…ë°©</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link rel="stylesheet" th:href="@{/assets/css/jm/chatView.css}">
</head>
<body>
    <div layout:fragment="content">
        <div class="chat-container">
            <div class="chat-view-wrapper">
                <div class="chat-header">
                    <div class="chat-header-title">
                        <span th:text="${room.room_name}">ì±„íŒ…ë°©</span>
                    </div>
                    <div class="chat-header-actions">
                        <button class="chat-header-btn" title="ë©¤ë²„ ëª©ë¡" onclick="toggleMemberList()"><span>ğŸ‘¥</span></button>
                    </div>
                </div>
                
                <div class="chat-member-list" id="memberList" style="display: none;">
                    <div class="member-list-header">
                        <h4>ë©¤ë²„ ëª©ë¡</h4>
                        <button onclick="toggleMemberList()" class="close-btn">Ã—</button>
                    </div>
                    <div class="member-list-content">
                        <div th:each="member : ${memberList}" class="member-item">
                            <span class="member-name" th:text="${member.user_name}">ì‚¬ìš©ì</span>
                            <span class="member-role" th:text="${member.role}">ì—­í• </span>
                        </div>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div th:each="message : ${messageList}" 
                         th:class="'chat-message-row ' + (${message.sender_num} == ${currentUserNum} ? 'me' : '')">
                        <div class="chat-bubble" th:text="${message.content}">ë©”ì‹œì§€ ë‚´ìš©</div>
                        <div class="chat-message-meta" th:text="${message.sent_at}">ì‹œê°„</div>
                    </div>
                </div>
                
                <form class="chat-input-area" id="chatSendForm" autocomplete="off" onsubmit="event.preventDefault(); sendMessage();">
                    <input type="hidden" name="room_num" th:value="${room.room_num}">
                    <input type="text" class="chat-input" name="message" id="messageInput" 
                           placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" required>
                    <button type="submit" class="chat-send-btn">ì „ì†¡</button>
                </form>
            </div>
        </div>
        
        <script th:inline="javascript">
            // Thymeleaf ë³€ìˆ˜ë¥¼ JavaScript ë³€ìˆ˜ë¡œ ë³€í™˜
            const roomNum = '[[${room.room_num}]]';
            const userNum = '[[${currentUserNum}]]';
            
            // CSRF í† í° ì„¤ì •
            const token = document.querySelector("meta[name='_csrf']").getAttribute("content");
            const header = document.querySelector("meta[name='_csrf_header']").getAttribute("content");
            
            function scrollChatToBottom() {
                var chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì±„íŒ… ì´ˆê¸°í™”
            document.addEventListener('DOMContentLoaded', function() {
                scrollChatToBottom();
                initChat(roomNum, userNum);
            });
            
            // ë©¤ë²„ ëª©ë¡ í† ê¸€
            function toggleMemberList() {
                const memberList = document.getElementById('memberList');
                memberList.style.display = memberList.style.display === 'none' ? 'block' : 'none';
            }
            
            // ì—”í„° í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        </script>
        <script th:src="@{/assets/js/chat.js}"></script>
    </div>
</body>
</html>